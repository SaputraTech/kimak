#!/bin/bash

# Fungsi untuk menginstal dan mengkonfigurasi limit IP
function install_limit_ip() {
  # Memeriksa apakah baris 1-6 sudah sesuai sebelum menggantinya
  if ! grep -q '"loglevel": "info"' /var/lib/marzban/xray_config.json; then
    # Mereplace baris 1-6 pada file xray_config.json hanya jika belum sesuai
    sed -i 's/\r//' /var/lib/marzban/xray_config.json
  else
    echo "Konfigurasi loglevel sudah ada, melewati penggantian."
  fi

  # Restart Marzban
  cd /opt/marzban
  docker compose down && docker compose up -d
  clear
  sleep 2
  
  # Definisikan warna untuk output terminal
  YELLOW='\033[1;33m'
  RED='\033[1;31m'
  GREEN='\033[1;32m'
  BLUE='\033[1;34m'
  CYAN='\033[0;36m'
  WHITE='\033[1;37m'
  NC='\033[0m' # No Color

  # Update dan install dependencies jika belum ada
  apt update
  if ! command -v python3 &> /dev/null; then
    apt install python3 -y
  fi
  if ! command -v pip3 &> /dev/null; then
    apt install python3-pip -y
  fi

  # Install libraries Python
  pip3 install -q websockets pytz
  clear
  sleep 2
  
  # Buat direktori jika belum ada
  mkdir -p /usr/local/bin/V2IpLimit

  # Mengunduh file Python dan konfigurasi jika belum ada
  if [ ! -f /usr/local/bin/V2IpLimit/v2_ip_limit.py ]; then
    wget -q -O /usr/local/bin/V2IpLimit/v2_ip_limit.py https://raw.githubusercontent.com/helehsemvakwkwk/vivi/main/v2_ip_limit.py
  fi
  clear
  sleep 2

  # Konfigurasi JSON hanya jika belum ada
  if [ ! -f /usr/local/bin/V2IpLimit/v2iplimit_config.json ] || ! grep -q "LIMIT_NUMBER" /usr/local/bin/V2IpLimit/v2iplimit_config.json; then
    read -p "$(echo -e "${WHITE}Mau Dikasih ${CYAN}Limit IP${WHITE} Berapa? : ${NC}")" LIMIT_NUMBER
    read -p "$(echo -e "${WHITE}Masukkan ${CYAN}Telegram Bot${WHITE} Token : ${NC}")" BOT_TOKEN
    read -p "$(echo -e "${WHITE}Masukkan ${CYAN}Chat ID${WHITE} Kamu : ${NC}")" CHAT_ID
    read -p "$(echo -e "${WHITE}Masukkan ${CYAN}Username Panel${WHITE} Kamu : ${NC}")" PANEL_USERNAME
    read -p "$(echo -e "${WHITE}Masukkan ${CYAN}Password Panel${WHITE} Kamu : ${NC}")" PANEL_PASSWORD
    read -p "$(echo -e "${WHITE}Masukkan Panel Domain ${CYAN}ex : sub.domain.com:6969${WHITE} : ${NC}")" PANEL_DOMAIN
    read -p "$(echo -e "${WHITE}Mau Cek Tiap Berapa Menit? ${CYAN}isi saja 4${WHITE} untuk 4 menit : ${NC}")" TIME_TO_CHECK
    read -p "$(echo -e "${WHITE}Mau Lock Berapa Menit? ${CYAN}isi saja 5${WHITE} untuk 5 menit : ${NC}")" INACTIVE_DURATION

    wget -q -O /usr/local/bin/V2IpLimit/v2iplimit_config.json https://raw.githubusercontent.com/helehsemvakwkwk/vivi/main/v2iplimit_config.json

    # Mengganti variabel dalam v2iplimit_config.json
    sed -i "s/\"LIMIT_NUMBER\":.*/\"LIMIT_NUMBER\": $LIMIT_NUMBER,/" /usr/local/bin/V2IpLimit/v2iplimit_config.json
    sed -i "s|\[add_your_bot_token_here\]|$BOT_TOKEN|g" /usr/local/bin/V2IpLimit/v2iplimit_config.json
    sed -i "s/\"CHAT_ID\":.*/\"CHAT_ID\": $CHAT_ID,/" /usr/local/bin/V2IpLimit/v2iplimit_config.json
    sed -i "s/\"PANEL_USERNAME\":.*/\"PANEL_USERNAME\": \"$PANEL_USERNAME\",/" /usr/local/bin/V2IpLimit/v2iplimit_config.json
    sed -i "s/\"PANEL_PASSWORD\":.*/\"PANEL_PASSWORD\": \"$PANEL_PASSWORD\",/" /usr/local/bin/V2IpLimit/v2iplimit_config.json
    sed -i "s/\"PANEL_DOMAIN\":.*/\"PANEL_DOMAIN\": \"$PANEL_DOMAIN\",/" /usr/local/bin/V2IpLimit/v2iplimit_config.json
    sed -i "s/\"TIME_TO_CHECK\":.*/\"TIME_TO_CHECK\": $TIME_TO_CHECK,/" /usr/local/bin/V2IpLimit/v2iplimit_config.json
    sed -i "s/\"INACTIVE_DURATION\":.*/\"INACTIVE_DURATION\": $INACTIVE_DURATION,/" /usr/local/bin/V2IpLimit/v2iplimit_config.json
  else
    echo "Konfigurasi sudah ada, melewati langkah input user."
  fi

  # Membuat file service systemd untuk menjalankan script secara otomatis
  SERVICE_FILE=/etc/systemd/system/v2iplimit.service

  echo "[Unit]
  Description=V2 IP Limit Script

  [Service]
  ExecStart=/usr/bin/python3 /usr/local/bin/V2IpLimit/v2_ip_limit.py
  WorkingDirectory=/usr/local/bin/V2IpLimit/
  Restart=always
  User=root

  [Install]
  WantedBy=multi-user.target" > $SERVICE_FILE

  # Reload systemd untuk mengenali service baru
  systemctl daemon-reload

  # Enable service agar otomatis berjalan saat boot
  systemctl enable v2iplimit.service

  # Start service untuk menjalankan script sekarang juga
  systemctl start v2iplimit.service

  echo -e "${GREEN}Instalasi selesai. Script v2_ip_limit.py telah diatur untuk berjalan otomatis di background.${NC}"
}

# Fungsi untuk menampilkan menu
function show_menu() {
  sleep 2
  clear
  echo -e "${YELLOW}###########################################${NC}"
  echo -e "${YELLOW}#####${CYAN}   Marzban Limit IP Menu v.6.9   ${YELLOW}#####${NC}"
  echo -e "${YELLOW}#####${NC}         SKT x AWN  Project      ${YELLOW}#####${NC}"
  echo -e "${YELLOW}###########################################${NC}"
  echo -e "\n[ ${GREEN}WAJIB${NC} ] Install Terlebih Dahulu !"
  echo -e "Seterusnya tinggal ${CYAN}eksekusi${NC} saja\n"
  echo -e "${CYAN}Pilih opsi dibawah :${NC}"
  echo -e "[ ${CYAN}1${NC} ] Install Limit IP"
  echo -e "[ ${CYAN}2${NC} ] Enable Limit IP"
  echo -e "[ ${CYAN}3${NC} ] Disable Limit IP"
  echo -e "[ ${CYAN}4${NC} ] Except Users"
  echo -e "[ ${CYAN}5${NC} ] Special Limit"
  echo -e "[ ${CYAN}6${NC} ] Edit Configuration"
  echo -e "[ ${CYAN}7${NC} ] Cek Status"
  echo -e "[ ${CYAN}8${NC} ] Uninstall Limit IP"
  echo -e "[ ${CYAN}x${NC} ] Exit"
  echo ""
}

# Loop menu
while true; do
  show_menu
  read -p "Pilih opsi: " choice
  case $choice in
    1) install_limit_ip ;;
    2) echo "Enable Limit IP belum diimplementasikan" ;;
    3) echo "Disable Limit IP belum diimplementasikan" ;;
    4) echo "Edit Except Users belum diimplementasikan" ;;
    5) echo "Update Special Limit belum diimplementasikan" ;;
    6) echo "Edit Configuration belum diimplementasikan" ;;
    7) echo "Cek Status belum diimplementasikan" ;;
    8) echo "Remove V2 IP Limit belum diimplementasikan" ;;
    x) exit ;;
    *) echo "Pilihan tidak valid, coba lagi." ;;
  esac
done
